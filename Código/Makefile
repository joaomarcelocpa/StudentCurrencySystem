# ==============================================================================
# Makefile - Sistema de Moeda Estudantil Virtus
# ==============================================================================

.PHONY: help
.DEFAULT_GOAL := help

# Colors
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[0;33m
RED := \033[0;31m
NC := \033[0m # No Color

# ==============================================================================
# HELP
# ==============================================================================

help: ## Mostra esta mensagem de ajuda
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "$(GREEN)  Sistema de Moeda Estudantil Virtus - Comandos Make$(NC)"
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(YELLOW)%-25s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"

# ==============================================================================
# DOCKER - COMANDOS PRINCIPAIS
# ==============================================================================

up: ## Sobe todos os containers em background
	@echo "$(GREEN)ğŸš€ Subindo containers...$(NC)"
	docker-compose up -d
	@echo "$(GREEN)âœ… Containers iniciados!$(NC)"
	@echo "$(YELLOW)Frontend: http://localhost:3000$(NC)"
	@echo "$(YELLOW)Backend:  http://localhost:8080$(NC)"

down: ## Para e remove todos os containers
	@echo "$(RED)ğŸ›‘ Parando containers...$(NC)"
	docker-compose down
	@echo "$(GREEN)âœ… Containers parados!$(NC)"

restart: ## Reinicia todos os containers
	@echo "$(YELLOW)ğŸ”„ Reiniciando containers...$(NC)"
	@$(MAKE) down
	@$(MAKE) up
	@echo "$(GREEN)âœ… Containers reiniciados!$(NC)"

stop: ## Para os containers sem removÃª-los
	@echo "$(YELLOW)â¸ï¸  Parando containers...$(NC)"
	docker-compose stop
	@echo "$(GREEN)âœ… Containers parados!$(NC)"

start: ## Inicia containers jÃ¡ existentes
	@echo "$(GREEN)â–¶ï¸  Iniciando containers...$(NC)"
	docker-compose start
	@echo "$(GREEN)âœ… Containers iniciados!$(NC)"

# ==============================================================================
# DOCKER - BUILD E REBUILD
# ==============================================================================

build: ## ReconstrÃ³i todas as imagens
	@echo "$(BLUE)ğŸ”¨ Reconstruindo todas as imagens...$(NC)"
	docker-compose build --no-cache
	@echo "$(GREEN)âœ… Imagens reconstruÃ­das!$(NC)"

rebuild: ## ReconstrÃ³i e sobe os containers
	@echo "$(BLUE)ğŸ”¨ Reconstruindo e subindo containers...$(NC)"
	docker-compose up -d --build
	@echo "$(GREEN)âœ… Containers reconstruÃ­dos e iniciados!$(NC)"

build-backend: ## ReconstrÃ³i apenas o backend
	@echo "$(BLUE)ğŸ”¨ Reconstruindo backend...$(NC)"
	docker-compose build --no-cache backend
	@echo "$(GREEN)âœ… Backend reconstruÃ­do!$(NC)"

build-frontend: ## ReconstrÃ³i apenas o frontend
	@echo "$(BLUE)ğŸ”¨ Reconstruindo frontend...$(NC)"
	docker-compose build --no-cache frontend
	@echo "$(GREEN)âœ… Frontend reconstruÃ­do!$(NC)"

# ==============================================================================
# LOGS
# ==============================================================================

logs: ## Mostra logs de todos os containers (follow)
	docker-compose logs -f

logs-backend: ## Mostra logs do backend
	docker-compose logs -f backend

logs-frontend: ## Mostra logs do frontend
	docker-compose logs -f frontend

# logs-db removido - banco PostgreSQL estÃ¡ no Azure (externo)

# ==============================================================================
# STATUS E INFORMAÃ‡Ã•ES
# ==============================================================================

ps: ## Lista status dos containers
	@echo "$(BLUE)ğŸ“Š Status dos containers:$(NC)"
	docker-compose ps

status: ps ## Alias para ps

stats: ## Mostra uso de recursos dos containers
	@echo "$(BLUE)ğŸ“ˆ Uso de recursos:$(NC)"
	docker stats --no-stream

# ==============================================================================
# ACESSO AOS CONTAINERS
# ==============================================================================

shell-backend: ## Abre shell no container do backend
	@echo "$(BLUE)ğŸš Abrindo shell do backend...$(NC)"
	docker exec -it virtus-backend sh

shell-frontend: ## Abre shell no container do frontend
	@echo "$(BLUE)ğŸš Abrindo shell do frontend...$(NC)"
	docker exec -it virtus-frontend sh

# shell-db removido - banco PostgreSQL estÃ¡ no Azure (use ferramentas Azure ou cliente psql local)

# ==============================================================================
# BANCO DE DADOS
# ==============================================================================
# NOTA: O banco PostgreSQL estÃ¡ hospedado no Azure (externo ao Docker)
# Use ferramentas do Azure ou cliente psql local para gerenciar o banco

db-info: ## Mostra informaÃ§Ãµes sobre conexÃ£o com banco Azure
	@echo "$(BLUE)ğŸ“Š InformaÃ§Ãµes do Banco de Dados:$(NC)"
	@echo "$(YELLOW)Banco: Azure PostgreSQL (externo)$(NC)"
	@echo "$(YELLOW)Gerenciamento: Use Azure Portal ou cliente psql local$(NC)"
	@echo ""
	@echo "$(YELLOW)VariÃ¡veis de ambiente (.env):$(NC)"
	@cat .env | grep -E "(SPRING_DATASOURCE_URL|POSTGRES_USER)" || echo "$(RED)Arquivo .env nÃ£o encontrado$(NC)"

# ==============================================================================
# LIMPEZA
# ==============================================================================

clean: ## Remove containers, volumes e imagens do projeto
	@echo "$(YELLOW)ğŸ§¹ Limpando containers e volumes...$(NC)"
	docker-compose down -v
	@echo "$(GREEN)âœ… Limpeza concluÃ­da!$(NC)"

clean-all: ## Remove tudo incluindo imagens
	@echo "$(RED)ğŸ§¹ Limpeza completa...$(NC)"
	docker-compose down -v --rmi all
	@echo "$(GREEN)âœ… Limpeza completa concluÃ­da!$(NC)"

prune: ## Remove todos os recursos Docker nÃ£o utilizados
	@echo "$(YELLOW)ğŸ§¹ Removendo recursos nÃ£o utilizados...$(NC)"
	docker system prune -a -f
	docker volume prune -f
	@echo "$(GREEN)âœ… Sistema limpo!$(NC)"

# ==============================================================================
# DESENVOLVIMENTO
# ==============================================================================

dev: ## Sobe containers e mostra logs (desenvolvimento)
	@echo "$(GREEN)ğŸš€ Modo desenvolvimento...$(NC)"
	docker-compose up

dev-backend: ## Inicia apenas backend + db e mostra logs
	@echo "$(GREEN)ğŸš€ Iniciando backend em modo desenvolvimento...$(NC)"
	docker-compose up postgres backend

dev-frontend: ## Inicia apenas frontend e mostra logs
	@echo "$(GREEN)ğŸš€ Iniciando frontend em modo desenvolvimento...$(NC)"
	docker-compose up frontend

# ==============================================================================
# TESTES E VALIDAÃ‡ÃƒO
# ==============================================================================

test: ## Testa se os serviÃ§os estÃ£o respondendo
	@echo "$(BLUE)ğŸ§ª Testando serviÃ§os...$(NC)"
	@echo -n "$(YELLOW)Backend:    $(NC)"
	@curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/actuator/health | grep -q "200" && echo "$(GREEN)âœ…$(NC)" || echo "$(RED)âŒ$(NC)"
	@echo -n "$(YELLOW)Frontend:   $(NC)"
	@curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 | grep -q "200" && echo "$(GREEN)âœ…$(NC)" || echo "$(RED)âŒ$(NC)"
	@echo "$(YELLOW)PostgreSQL: Azure (externo) - verifique no Azure Portal$(NC)"

health: ## Verifica saÃºde dos containers
	@echo "$(BLUE)ğŸ¥ Verificando saÃºde dos containers...$(NC)"
	@docker-compose ps

ping: ## Testa conectividade com os serviÃ§os
	@echo "$(BLUE)ğŸ“ Testando conectividade...$(NC)"
	@echo "Frontend:"
	@curl -s http://localhost:3000 > /dev/null && echo "$(GREEN)âœ… OK$(NC)" || echo "$(RED)âŒ FALHOU$(NC)"
	@echo "Backend:"
	@curl -s http://localhost:8080/actuator/health && echo "" || echo "$(RED)âŒ FALHOU$(NC)"

# ==============================================================================
# USUÃRIOS DE TESTE
# ==============================================================================

seed: ## Cria usuÃ¡rios de teste no sistema
	@echo "$(BLUE)ğŸŒ± Criando usuÃ¡rios de teste...$(NC)"
	@echo "$(YELLOW)Aguarde os containers iniciarem (30s)...$(NC)"
	@sleep 30
	@echo "$(YELLOW)Criando Admin...$(NC)"
	@curl -s -X POST http://localhost:8080/api/admins/cadastro \
		-H "Content-Type: application/json" \
		-d '{"login":"admin","senha":"admin123","nome":"Administrador do Sistema","email":"admin@virtus.com","cpf":"12345678900"}' \
		&& echo "$(GREEN)âœ… Admin criado$(NC)" || echo "$(RED)âŒ Erro ao criar admin$(NC)"
	@echo "$(YELLOW)Criando Professor...$(NC)"
	@curl -s -X POST http://localhost:8080/api/professores/cadastro \
		-H "Content-Type: application/json" \
		-d '{"login":"professor","senha":"prof123","nome":"Prof. JoÃ£o Silva","cpf":"11122233344","departamento":"ComputaÃ§Ã£o"}' \
		&& echo "$(GREEN)âœ… Professor criado$(NC)" || echo "$(RED)âŒ Erro ao criar professor$(NC)"
	@echo "$(YELLOW)Criando Aluno...$(NC)"
	@curl -s -X POST http://localhost:8080/api/alunos/cadastro \
		-H "Content-Type: application/json" \
		-d '{"login":"aluno","senha":"aluno123","nome":"Maria Santos","email":"maria@email.com","cpf":"99988877766","rg":"123456","endereco":"Rua A, 123"}' \
		&& echo "$(GREEN)âœ… Aluno criado$(NC)" || echo "$(RED)âŒ Erro ao criar aluno$(NC)"
	@echo ""
	@echo "$(GREEN)âœ… UsuÃ¡rios de teste criados!$(NC)"
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "$(YELLOW)Admin:     $(NC)admin / admin123"
	@echo "$(YELLOW)Professor: $(NC)professor / prof123"
	@echo "$(YELLOW)Aluno:     $(NC)aluno / aluno123"
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"

# ==============================================================================
# INSTALAÃ‡ÃƒO E SETUP
# ==============================================================================

install: ## Instala o projeto (build + up + seed)
	@echo "$(BLUE)ğŸ“¦ Instalando projeto...$(NC)"
	@$(MAKE) build
	@$(MAKE) up
	@$(MAKE) seed
	@echo "$(GREEN)âœ… Projeto instalado com sucesso!$(NC)"
	@echo "$(YELLOW)Acesse: http://localhost:3000$(NC)"

setup: install ## Alias para install

first-run: install ## Primeira execuÃ§Ã£o do projeto

# ==============================================================================
# INFORMAÃ‡Ã•ES
# ==============================================================================

info: ## Mostra informaÃ§Ãµes do projeto
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "$(GREEN)  Sistema de Moeda Estudantil Virtus$(NC)"
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ“¦ ServiÃ§os Docker:$(NC)"
	@echo "  Frontend:   http://localhost:3000"
	@echo "  Backend:    http://localhost:8080"
	@echo ""
	@echo "$(YELLOW)ğŸ—„ï¸  Banco de Dados:$(NC)"
	@echo "  PostgreSQL: Azure (externo ao Docker)"
	@echo ""
	@echo "$(YELLOW)ğŸ‘¥ UsuÃ¡rios de teste:$(NC)"
	@echo "  Admin:      admin / admin123"
	@echo "  Professor:  professor / prof123"
	@echo "  Aluno:      aluno / aluno123"
	@echo ""
	@echo "$(YELLOW)ğŸ“š DocumentaÃ§Ã£o:$(NC)"
	@echo "  README.md"
	@echo "  DOCKER_README.md"
	@echo "  MAKEFILE_GUIDE.md"
	@echo "  ENV_GUIDE.md"
	@echo ""
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"

urls: ## Mostra URLs dos serviÃ§os
	@echo "$(BLUE)ğŸŒ URLs dos serviÃ§os:$(NC)"
	@echo "Frontend:   $(GREEN)http://localhost:3000$(NC)"
	@echo "Backend:    $(GREEN)http://localhost:8080$(NC)"
	@echo "PostgreSQL: $(YELLOW)Azure (externo)$(NC)"

# ==============================================================================
# VARIÃVEIS DE AMBIENTE
# ==============================================================================

env-setup: ## Copia .env.example para .env
	@if [ -f .env ]; then \
		echo "$(YELLOW)âš ï¸  Arquivo .env jÃ¡ existe$(NC)"; \
		echo "$(YELLOW)Para sobrescrever, execute: make env-reset$(NC)"; \
	else \
		cp .env.example .env; \
		echo "$(GREEN)âœ… Arquivo .env criado!$(NC)"; \
		echo "$(YELLOW)Edite o arquivo .env conforme necessÃ¡rio$(NC)"; \
	fi

env-reset: ## Reseta .env para valores padrÃ£o
	@echo "$(YELLOW)âš ï¸  Resetando arquivo .env...$(NC)"
	cp .env.example .env
	@echo "$(GREEN)âœ… Arquivo .env resetado!$(NC)"

env-show: ## Mostra variÃ¡veis de ambiente
	@echo "$(BLUE)ğŸ”§ VariÃ¡veis de ambiente (.env):$(NC)"
	@cat .env | grep -v "^#" | grep -v "^$$"

env-validate: ## Valida se .env existe
	@if [ ! -f .env ]; then \
		echo "$(RED)âŒ Arquivo .env nÃ£o encontrado!$(NC)"; \
		echo "$(YELLOW)Execute: make env-setup$(NC)"; \
		exit 1; \
	else \
		echo "$(GREEN)âœ… Arquivo .env encontrado$(NC)"; \
	fi

env-edit: ## Abre .env para ediÃ§Ã£o
	@if [ ! -f .env ]; then \
		echo "$(RED)âŒ Arquivo .env nÃ£o encontrado!$(NC)"; \
		echo "$(YELLOW)Execute primeiro: make env-setup$(NC)"; \
		exit 1; \
	fi
	@echo "$(BLUE)ğŸ“ Abrindo .env para ediÃ§Ã£o...$(NC)"
	@nano .env || vim .env || code .env || notepad .env
